<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Data Setup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script>
        function validate() {
            var Trend_type_selection = document.getElementById("Trend_type_selection");   
            var Trend_types = getSelectValues(Trend_type_selection);

            if (Trend_types === undefined || Trend_types.length == 0) {
                alert("Please select the Trend type!");
                return false;
            }

            return true;
        }

        function getSelectValues(select) {
            var result = [];
            var options = select && select.options;
            var opt;
        
            for (var i=0, iLen=options.length; i<iLen; i++) {
            opt = options[i];
        
            if (opt.selected) {
                result.push(opt.text);
            }
            }
            return result;
        }

        function update_qual_thresh(val) {
            document.getElementById('qual_thresh_label').innerText=val; 
        }

        var folder = "";

        function getFolder(e) {
            var files = e.target.files;
            var path = files[0].webkitRelativePath;

            var path_split = path.split("/");
            folder = path_split[0];
        }

        $(function() {
            // initialize 
            selectTypeValue = "pearson_corr";
            
            $('#open-file-btn').click(function() {

                if (folder != "") {
                    // folder chosen for saved data
                    $('#projectName').val(folder);

                    $.ajax({
                        type: 'POST',
                        url: '/',
                        data: {'action':'folder_open', 'folder': folder},                               
                        success: function(data) {
                            var var_names = data.var_names;
                            var var_types = data.var_types;
                            var samples = data.samples;
                            var isCounts = data.isCounts;
                            var roles = data.roles;
                            var possibleRoles = data.possible_roles;
                            var weighting_vars = data.weighting_vars;
                            roleTable(var_names, var_types, samples, possibleRoles, isCounts, roles, weighting_vars);

                            // populate Trend type dropdown options
                            var option = '';
                            var Trend_types = data.Trend_types;
                            var Trend_type_list = data.Trend_type_list;

                            for (var i=0;i<Trend_types.length;i++){
                                if (Trend_type_list.includes(Trend_types[i])){
                                    option += '<option id="Trend_type_option" value="'+ Trend_types[i] + '" selected>' + Trend_types[i] + '</option>';
                                } else {
                                    option += '<option id="Trend_type_option" value="'+ Trend_types[i] + '">' + Trend_types[i] + '</option>';
                                }
                            }
                            $('#Trend_type_selection').append(option);

                            // Avoid ctrl-click                                    
                            $('option').mousedown(function(e) {
                                e.preventDefault();
                                var originalScrollTop = $(this).parent().scrollTop();
                                $(this).prop('selected', $(this).prop('selected') ? false : true);
                                var self = this;
                                $(this).parent().focus();
                                setTimeout(function() {
                                    $(self).parent().scrollTop(originalScrollTop);
                                }, 0);
                                
                                return false;
                            });                                   
                        }
                    })
                } else {
                    // When data file chosen
                    var form_data = new FormData($('#open-file')[0]);
                    var action = $('#open-file-btn').val();
                    form_data.append('action', action);

                    d3.select('#roleSelection').select("table").remove();
                    var header;
                    var file = document.querySelector('input[type=file]').files[0]; 

                    if (file) {
                        var reader = new FileReader();
                        reader.onloadend = function(evt) {
                            var dataUrl = evt.target.result;

                            d3.csv( dataUrl, function( rows ) {
                                header = Object.keys(rows[0]);

                                $.ajax({
                                    type: 'POST',
                                    url: '/',
                                    data: form_data,                                
                                    contentType: false,
                                    cache: false,
                                    processData: false,
                                    success: function(data) {
                                        var var_types = data.var_types;
                                        var samples = data.samples;
                                        var possibleRoles = data.possible_roles;
                                        roleTable(header, var_types, samples, possibleRoles);

                                        // populate Trend type dropdown options
                                        var option = '';
                                        var Trend_types = data.Trend_types;
                                        for (var i=0;i<Trend_types.length;i++){
                                            option += '<option id="Trend_type_option" value="'+ Trend_types[i] + '">' + Trend_types[i] + '</option>';
                                        }
                                        $('#Trend_type_selection').append(option);

                                        // Avoid ctrl-click                                    
                                        $('option').mousedown(function(e) {
                                            e.preventDefault();
                                            var originalScrollTop = $(this).parent().scrollTop();
                                            $(this).prop('selected', $(this).prop('selected') ? false : true);
                                            var self = this;
                                            $(this).parent().focus();
                                            setTimeout(function() {
                                                $(self).parent().scrollTop(originalScrollTop);
                                            }, 0);
                                            
                                            return false;
                                        });                                    
                                    },
                                });
                            })
                        };
                        reader.readAsDataURL(file);
                    }  
                }              
            });

            $('#visualize-btn').click(function() {
                var form_data = new FormData($('#open-file')[0]);
                var action = $('#visualize-btn').val();

                form_data.append('action', action);

                var metaList = [];
                metaList = getMetaList();
                
                form_data.append('metaList', metaList);

                var Trend_type_selection = document.getElementById("Trend_type_selection");   
                var Trend_types = getSelectValues(Trend_type_selection);
                form_data.append('Trend_types', Trend_types);

                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {
                        
                    },
                });
                
            });

            $('#save-btn').click(function() {
                var form_data = new FormData($('#open-file')[0]);
                var action = $('#save-btn').val();
                var projectName = $('#projectName').val();
                
                if (projectName == '') {
                    alert("Please input your project name!")
                    return;
                }

                form_data.append('action', action);
                form_data.append('projectName', projectName);

                var metaList = [];
                metaList = getMetaList();
                form_data.append('metaList', metaList);

                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {
                        var saved = document.getElementById("save-label");
                        saved.innerText = data;
                    },
                });
                
            });  
            
            $('#quantiles-btn').click(function() {
                var form_data = new FormData($('#open-file')[0]);
                var action = $('#quantiles-btn').val();

                form_data.append('action', action);

                var metaList = [];
                metaList = getMetaList();
                form_data.append('metaList', metaList);

                var checked_vars = [];

                var quantiles_checkbox = document.getElementsByName("quantiles_checkbox");

                for (var i = 0; i < quantiles_checkbox.length; i++) {
                    if (quantiles_checkbox[i].checked) {
                        checked_vars.push(quantiles_checkbox[i].value);
                    }
                }

                form_data.append('checked_vars', checked_vars);

                var user_cutoffs = $('#user_cutoffs').val();
                form_data.append('user_cutoffs', user_cutoffs);

                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {
                        d3.select('#roleSelection').select("table").remove();

                        var var_names = data.var_names;
                        var var_types = data.var_types;
                        var samples = data.samples;
                        var isCounts = data.isCounts;
                        var roles = data.roles;
                        var possibleRoles = data.possible_roles;
                        var weighting_vars = data.weighting_vars;

                        roleTable(var_names, var_types, samples, possibleRoles, isCounts, roles, weighting_vars, checked_vars);      
                        
                        // Avoid ctrl-click                                    
                        $('option:not(#Trend_type_option)').mousedown(function(e) {
                            e.preventDefault();
                            var originalScrollTop = $(this).parent().scrollTop();

                            $(this).prop('selected', $(this).prop('selected') ? false : true);
                            var self = this;
                            $(this).parent().focus();
                            setTimeout(function() {
                                $(self).parent().scrollTop(originalScrollTop);
                            }, 0);
                            
                            return false;
                        });                              
                    },
                });
                
            }); 

            $('#clustering-btn').click(function() {
                var form_data = new FormData($('#open-file')[0]);
                var action = $('#clustering-btn').val();

                form_data.append('action', action);

                var metaList = [];
                metaList = getMetaList();
                form_data.append('metaList', metaList);

                var qual_thresh = document.getElementById("qual_thresh").value;
                form_data.append('qual_thresh', qual_thresh);

                var checked_vars = [];

                var quantiles_checkbox = document.getElementsByName("quantiles_checkbox");

                for (var i = 0; i < quantiles_checkbox.length; i++) {
                    if (quantiles_checkbox[i].checked) {
                        checked_vars.push(quantiles_checkbox[i].value);
                    }
                }

                $.ajax({
                    type: 'POST',
                    url: '/',
                    data: form_data,
                    contentType: false,
                    cache: false,
                    processData: false,
                    success: function(data) {
                        d3.select('#roleSelection').select("table").remove();

                        var var_names = data.var_names;
                        var var_types = data.var_types;
                        var samples = data.samples;
                        var isCounts = data.isCounts;
                        var roles = data.roles;
                        var possibleRoles = data.possible_roles;
                        var weighting_vars = data.weighting_vars;

                        roleTable(var_names, var_types, samples, possibleRoles, isCounts, roles, weighting_vars, checked_vars);      
                        
                        // Avoid ctrl-click                                    
                        $('option:not(#Trend_type_option)').mousedown(function(e) {
                            e.preventDefault();
                            var originalScrollTop = $(this).parent().scrollTop();

                            $(this).prop('selected', $(this).prop('selected') ? false : true);
                            var self = this;
                            $(this).parent().focus();
                            setTimeout(function() {
                                $(self).parent().scrollTop(originalScrollTop);
                            }, 0);
                            
                            return false;
                        });                              
                    },
                });
                
            });             
        });           
    </script>
</head>
<body class="center">
 <!--  <form id="upload-file" method="post" enctype="multipart/form-data">   -->
  <form id="open-file" action="/visualize" method="post" onsubmit="return validate();"> 

    <div class= "row">
        <div id="extra">
            <br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <label style="font-size: 14px;">Choose one file to load a new dataset or a direcotry with previously saved metadata</label><br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input name="file" type="file" id="myFile" style = "width:170px">
            <input name="file" type="file" id="myFolder" onchange="getFolder(event)" style = "width:170px" multiple webkitdirectory mozdirectory msdirectory odirectory directory>
            <button id="open-file-btn" type="button" value="open">Open</button>&nbsp;&nbsp;&nbsp;&nbsp;
            <select id = "Trend_type_selection" multiple="multiple">
            </select>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <div id="control_table">
                <table class="rankingparam" cellspacing="0" cellpadding="0" align="center">
                    <tr class = "paramtr">
                        <td class="param">            
                            <input name="user_cutoffs" type="text" id="user_cutoffs" placeholder="Quantiles(e.g., 0.25,0.75)">
                        </td>
                        <td class="param">            
                            <button id="quantiles-btn" type="button" value="quantiles">Compute Quantiles</button>
                        </td>
                        <td class="param">  
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <button id="visualize-btn" type="submit" value="visualize">Visualize Trends</button> 
                        </td>                                         
                    </tr>
                    <tr class = "paramtr">
                        <td class="param">
                            <input type="range" style = "width: 115px;" min="0" max="1" step="0.01" id="qual_thresh" value = "0.2" onchange="update_qual_thresh(this.value);">
                            &nbsp;<label id="qual_thresh_label" style="font-size: 12px;">0.2</label>  
                        </td>
                        <td class="param">
                            <button id="clustering-btn" type="button" value="clustering">Clustering</button> 
                        </td>                    
                    </tr>
                    <tr class = "paramtr">
                        <td class="param">
                                <input name="projectName" type="text" id="projectName" placeholder="Project Name">                        
                        </td>
                        <td class="param">
                                <button id="save-btn" type="button" value="save">Save</button>    
                                <label id="save-label" style="font-size: 14px;"></label>                                            
                        </td>                    
                    </tr>                                    
                </table>
            </div>
        </div> 
        <div id="typeSelector">
            <br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <div id="roleSelection">
        </div>             
    </div>
    <script src="{{ url_for('static', filename='js/table.js') }}"></script>    
    </form>

</body>
